# Phase 2.5: User Onboarding

**Status:** Draft
**Branch:** `feature/user-onboarding`
**Depends On:** Phase 1 (App Shell Layout), Phase 2 (Overview Dashboard)
**Estimated Files:** 9 new, 4 modified, 0 removed

---

## Overview

First sign-in experience for new users. A multi-step wizard that collects essential preferences before allowing access to the main dashboard. This ensures users have a personalized experience from their first interaction.

### Goals
1. Detect first-time users and redirect to onboarding
2. Collect theme preference
3. Set default dashboard view (cards vs table, all regions vs single region)
4. Optionally link WorkStudio credentials
5. Store preferences in database
6. Mark user as "onboarded" to prevent repeat

### Non-Goals (Future Phases)
- Full profile setup
- Team/role selection
- Tutorial walkthrough
- Custom widget selection

---

## User Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                        FIRST LOGIN                               │
│                                                                  │
│   User registers/logs in for first time                         │
│                  ↓                                               │
│   Middleware detects `onboarded_at` is null                     │
│                  ↓                                               │
│   Redirect to /onboarding                                        │
└─────────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│                    STEP 1: WELCOME                               │
│                                                                  │
│   "Welcome to WS-Tracker, [Name]!"                              │
│                                                                  │
│   Brief intro text explaining the dashboard                      │
│                                                                  │
│                              [Get Started →]                     │
└─────────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│                  STEP 2: THEME SELECTION                         │
│                                                                  │
│   "Choose your theme"                                            │
│                                                                  │
│   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │
│   │  Light  │  │  Dark   │  │   PPL   │  │   PPL   │           │
│   │         │  │         │  │  Light  │  │  Dark   │           │
│   │ [thumb] │  │ [thumb] │  │ [thumb] │  │ [thumb] │           │
│   └─────────┘  └─────────┘  └─────────┘  └─────────┘           │
│                                                                  │
│   [ ] Follow system preference                                   │
│                                                                  │
│                    [← Back]  [Continue →]                        │
└─────────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│                STEP 3: DASHBOARD PREFERENCES                     │
│                                                                  │
│   "Set up your dashboard"                                        │
│                                                                  │
│   Default view:                                                  │
│   ○ Card grid                                                    │
│   ● Data table                                                   │
│                                                                  │
│   Show on login:                                                 │
│   ○ All regions overview                                         │
│   ● My region only (select below)                                │
│                                                                  │
│   Your region: [Lehigh          ▼]                              │
│                                                                  │
│                    [← Back]  [Continue →]                        │
└─────────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│              STEP 4: WORKSTUDIO CREDENTIALS (Optional)           │
│                                                                  │
│   "Link your WorkStudio account"                                 │
│                                                                  │
│   Linking your account enables:                                  │
│   • View your assigned circuits                                  │
│   • See your planning metrics                                    │
│   • Sync your work data                                          │
│                                                                  │
│   Username: [____________________]                               │
│   Password: [____________________]                               │
│                                                                  │
│   [Skip for now]           [← Back]  [Link & Finish →]          │
└─────────────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────────────┐
│                      STEP 5: COMPLETE                            │
│                                                                  │
│   ✓ "You're all set!"                                           │
│                                                                  │
│   Your preferences have been saved.                              │
│   You can change these anytime in Settings.                      │
│                                                                  │
│                      [Go to Dashboard →]                         │
└─────────────────────────────────────────────────────────────────┘
```

---

## Database Changes

### Add to Users Table

```php
// Migration
Schema::table('users', function (Blueprint $table) {
    $table->timestamp('onboarded_at')->nullable()->after('theme_preference');
    $table->json('dashboard_preferences')->nullable()->after('onboarded_at');
});
```

**`dashboard_preferences` JSON Structure:**
```json
{
    "default_view": "cards",           // cards|table
    "show_all_regions": false,         // true = all, false = user's region only
    "default_region_id": 3,            // User's preferred region
    "sidebar_collapsed": false         // Sidebar state preference
}
```

---

## Theme Configuration

### Config File (`config/themes.php`)

Central configuration for all available themes. This allows easy addition/removal of themes without code changes.

```php
<?php

return [
    /*
    |--------------------------------------------------------------------------
    | Default Theme
    |--------------------------------------------------------------------------
    |
    | The default theme for new users before they complete onboarding.
    | Also used as fallback if user's theme preference is invalid.
    |
    */
    'default' => 'corporate',

    /*
    |--------------------------------------------------------------------------
    | Theme Categories
    |--------------------------------------------------------------------------
    |
    | Organize themes into categories for the theme picker UI.
    | 'featured' themes appear first/prominently in the picker.
    |
    */
    'categories' => [
        'featured' => [
            'label' => 'Recommended',
            'themes' => ['corporate', 'light', 'dark'],
        ],
        'brand' => [
            'label' => 'PPL Brand',
            'themes' => ['ppl-light', 'ppl-dark'],
        ],
        'light' => [
            'label' => 'Light Themes',
            'themes' => ['cupcake', 'emerald', 'corporate', 'retro', 'garden', 'winter', 'autumn', 'silk'],
        ],
        'dark' => [
            'label' => 'Dark Themes',
            'themes' => ['dark', 'synthwave', 'cyberpunk', 'dracula', 'night', 'forest', 'coffee'],
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | Available Themes
    |--------------------------------------------------------------------------
    |
    | All available DaisyUI themes with metadata for the picker.
    | 'colorScheme' determines if theme is light or dark (for system preference).
    |
    */
    'available' => [
        // Featured / Default
        'corporate' => [
            'name' => 'Corporate',
            'colorScheme' => 'light',
            'description' => 'Professional and clean',
        ],
        'light' => [
            'name' => 'Light',
            'colorScheme' => 'light',
            'description' => 'Default light theme',
        ],
        'dark' => [
            'name' => 'Dark',
            'colorScheme' => 'dark',
            'description' => 'Default dark theme',
        ],

        // PPL Brand
        'ppl-light' => [
            'name' => 'PPL Light',
            'colorScheme' => 'light',
            'description' => 'PPL Electric brand colors',
        ],
        'ppl-dark' => [
            'name' => 'PPL Dark',
            'colorScheme' => 'dark',
            'description' => 'PPL Electric brand colors (dark)',
        ],

        // Light Themes
        'cupcake' => [
            'name' => 'Cupcake',
            'colorScheme' => 'light',
            'description' => 'Soft and pastel',
        ],
        'emerald' => [
            'name' => 'Emerald',
            'colorScheme' => 'light',
            'description' => 'Green accents',
        ],
        'retro' => [
            'name' => 'Retro',
            'colorScheme' => 'light',
            'description' => 'Vintage vibes',
        ],
        'garden' => [
            'name' => 'Garden',
            'colorScheme' => 'light',
            'description' => 'Natural greens',
        ],
        'winter' => [
            'name' => 'Winter',
            'colorScheme' => 'light',
            'description' => 'Cool blues',
        ],
        'autumn' => [
            'name' => 'Autumn',
            'colorScheme' => 'light',
            'description' => 'Warm earth tones',
        ],
        'silk' => [
            'name' => 'Silk',
            'colorScheme' => 'light',
            'description' => 'Elegant and smooth',
        ],

        // Dark Themes
        'synthwave' => [
            'name' => 'Synthwave',
            'colorScheme' => 'dark',
            'description' => '80s neon aesthetic',
        ],
        'cyberpunk' => [
            'name' => 'Cyberpunk',
            'colorScheme' => 'dark',
            'description' => 'Futuristic yellow',
        ],
        'dracula' => [
            'name' => 'Dracula',
            'colorScheme' => 'dark',
            'description' => 'Popular dark scheme',
        ],
        'night' => [
            'name' => 'Night',
            'colorScheme' => 'dark',
            'description' => 'Deep dark blue',
        ],
        'forest' => [
            'name' => 'Forest',
            'colorScheme' => 'dark',
            'description' => 'Dark greens',
        ],
        'coffee' => [
            'name' => 'Coffee',
            'colorScheme' => 'dark',
            'description' => 'Warm browns',
        ],
    ],

    /*
    |--------------------------------------------------------------------------
    | System Theme Mapping
    |--------------------------------------------------------------------------
    |
    | When user selects "Follow system", map to these themes.
    |
    */
    'system_mapping' => [
        'light' => 'corporate',  // System light → corporate
        'dark' => 'dark',        // System dark → dark
    ],
];
```

### Usage Examples

```php
// Get default theme
$default = config('themes.default'); // 'corporate'

// Get all available themes
$themes = config('themes.available');

// Get themes by category
$darkThemes = config('themes.categories.dark.themes');

// Check if theme is dark
$isDark = config("themes.available.{$theme}.colorScheme") === 'dark';

// Get system mapping
$systemLight = config('themes.system_mapping.light'); // 'corporate'
```

---

## Component Specifications

### 1. Onboarding Layout (`components/layouts/onboarding.blade.php`)

Simplified layout for onboarding flow (no sidebar).

```html
@props([
    'step' => 1,
    'totalSteps' => 5,
])
```

**Structure:**
```
┌─────────────────────────────────────────────────────────────────┐
│                         [Logo]                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   Step 2 of 5                                                    │
│   ●━━●━━○━━○━━○                                                 │
│                                                                  │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                                                         │   │
│   │              [Step Content via $slot]                   │   │
│   │                                                         │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**DaisyUI Components:**
- `steps` for progress indicator
- `card` for content container

---

### 2. Step Indicator (`components/ui/step-indicator.blade.php`)

Progress indicator showing current step.

```html
@props([
    'current' => 1,
    'total' => 5,
    'labels' => [],  // Optional step labels
])
```

**DaisyUI Structure:**
```html
<ul class="steps steps-horizontal w-full">
    @for($i = 1; $i <= $total; $i++)
        <li class="step {{ $i <= $current ? 'step-primary' : '' }}">
            {{ $labels[$i - 1] ?? '' }}
        </li>
    @endfor
</ul>
```

---

### 3. Theme Picker (`components/ui/theme-picker.blade.php`)

Visual theme selection grid. Themes loaded from config file.

```html
@props([
    'selected' => 'system',
    'themes' => null,  // Loaded from config('themes.available')
])

@php
    $themes = $themes ?? config('themes.available', []);
    $categories = config('themes.categories', []);
@endphp
```

**Layout:**
```html
<div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    @foreach($themes as $theme)
        <button
            wire:click="selectTheme('{{ $theme }}')"
            class="card card-bordered {{ $selected === $theme ? 'ring-2 ring-primary' : '' }}"
        >
            <div class="card-body items-center p-4">
                <!-- Theme preview thumbnail -->
                <div class="w-full h-20 rounded bg-{{ $theme }}-preview">
                    <!-- Mini preview of theme colors -->
                </div>
                <span class="mt-2 font-medium">{{ ucfirst($theme) }}</span>
            </div>
        </button>
    @endforeach
</div>

<label class="label cursor-pointer justify-start gap-2 mt-4">
    <input
        type="checkbox"
        class="checkbox checkbox-primary"
        wire:model="useSystemTheme"
    />
    <span class="label-text">Follow system preference</span>
</label>
```

---

### 4. Onboarding Livewire Component (`app/Livewire/Onboarding/OnboardingWizard.php`)

```php
class OnboardingWizard extends Component
{
    public int $step = 1;
    public int $totalSteps = 5;

    // Step 2: Theme
    public string $selectedTheme = 'system';
    public bool $useSystemTheme = true;

    // Step 3: Dashboard preferences
    public string $defaultView = 'cards';
    public bool $showAllRegions = true;
    public ?int $defaultRegionId = null;

    // Step 4: WorkStudio credentials
    public string $wsUsername = '';
    public string $wsPassword = '';
    public bool $skipWsLink = false;

    // Validation
    protected function rules(): array
    {
        return [
            'selectedTheme' => 'required|in:system,light,dark,ppl-light,ppl-dark',
            'defaultView' => 'required|in:cards,table',
            'showAllRegions' => 'boolean',
            'defaultRegionId' => 'nullable|exists:regions,id',
            'wsUsername' => 'nullable|string|max:255',
            'wsPassword' => 'nullable|string|max:255',
        ];
    }

    #[Computed]
    public function regions(): Collection
    {
        return Region::where('is_active', true)
            ->orderBy('sort_order')
            ->get();
    }

    public function nextStep(): void
    {
        $this->validateCurrentStep();
        $this->step = min($this->step + 1, $this->totalSteps);
    }

    public function previousStep(): void
    {
        $this->step = max($this->step - 1, 1);
    }

    public function skipWsCredentials(): void
    {
        $this->skipWsLink = true;
        $this->nextStep();
    }

    public function complete(): void
    {
        $user = auth()->user();

        // Save theme preference
        $user->theme_preference = $this->useSystemTheme
            ? 'system'
            : $this->selectedTheme;

        // Save dashboard preferences
        $user->dashboard_preferences = [
            'default_view' => $this->defaultView,
            'show_all_regions' => $this->showAllRegions,
        ];

        // Save default region
        if (!$this->showAllRegions && $this->defaultRegionId) {
            $user->default_region_id = $this->defaultRegionId;
        }

        // Mark as onboarded
        $user->onboarded_at = now();

        $user->save();

        // Handle WS credentials if provided
        if (!$this->skipWsLink && $this->wsUsername && $this->wsPassword) {
            $this->linkWorkStudioAccount();
        }

        // Redirect to dashboard
        $this->redirect(route('assessments.overview'));
    }

    private function linkWorkStudioAccount(): void
    {
        // Encrypt and store credentials
        // Validate against WorkStudio API
        // Update user's ws_* fields
    }
}
```

---

### 5. Onboarding Middleware (`app/Http/Middleware/EnsureUserIsOnboarded.php`)

```php
class EnsureUserIsOnboarded
{
    public function handle(Request $request, Closure $next): Response
    {
        if (auth()->check() && auth()->user()->onboarded_at === null) {
            // Allow access to onboarding routes
            if ($request->routeIs('onboarding.*')) {
                return $next($request);
            }

            // Allow logout
            if ($request->routeIs('logout')) {
                return $next($request);
            }

            return redirect()->route('onboarding.index');
        }

        return $next($request);
    }
}
```

---

## Folder Structure

```
resources/views/
├── components/
│   ├── layouts/
│   │   └── onboarding.blade.php         # NEW: Onboarding layout
│   └── ui/
│       ├── step-indicator.blade.php     # NEW
│       └── theme-picker.blade.php       # NEW
│
├── livewire/
│   └── onboarding/
│       ├── wizard.blade.php             # NEW: Main wizard view
│       └── steps/
│           ├── welcome.blade.php        # NEW: Step 1
│           ├── theme.blade.php          # NEW: Step 2
│           ├── preferences.blade.php    # NEW: Step 3
│           ├── credentials.blade.php    # NEW: Step 4
│           └── complete.blade.php       # NEW: Step 5

app/
├── Http/
│   └── Middleware/
│       └── EnsureUserIsOnboarded.php    # NEW
└── Livewire/
    └── Onboarding/
        └── OnboardingWizard.php         # NEW
```

---

## Files Summary

### Files to Create (9)

| File | Purpose |
|------|---------|
| `config/themes.php` | Central theme configuration (all available themes) |
| `resources/views/components/layouts/onboarding.blade.php` | Onboarding layout |
| `resources/views/components/ui/step-indicator.blade.php` | Progress indicator |
| `resources/views/components/ui/theme-picker.blade.php` | Theme selection grid |
| `app/Livewire/Onboarding/OnboardingWizard.php` | Main wizard component |
| `resources/views/livewire/onboarding/wizard.blade.php` | Wizard view |
| `app/Http/Middleware/EnsureUserIsOnboarded.php` | Redirect middleware |
| `database/migrations/xxxx_add_onboarding_to_users.php` | DB migration |
| `tests/Feature/OnboardingTest.php` | Feature tests |

### Files to Modify (4)

| File | Change |
|------|--------|
| `app/Models/User.php` | Add `dashboard_preferences` cast, `onboarded_at` date |
| `bootstrap/app.php` | Register onboarding middleware |
| `routes/web.php` | Add onboarding routes |
| `app/Livewire/Assessments/Dashboard/Overview.php` | Read user preferences |

### Files to Remove (0)

None - this is new functionality.

---

## Responsive Behavior

| Breakpoint | Layout |
|------------|--------|
| Mobile (<640px) | Full width, stacked buttons |
| Tablet (640-1024px) | Centered card, max-width 600px |
| Desktop (>1024px) | Centered card, max-width 700px |

Theme picker shows 2 columns on mobile, 4 on tablet+.

---

## Acceptance Criteria

### Flow
- [ ] New users redirected to onboarding on first login
- [ ] Returning users (onboarded_at set) go directly to dashboard
- [ ] Step indicator shows progress
- [ ] Back button works on all steps (except first)
- [ ] Skip option works for WS credentials

### Theme Selection
- [ ] All themes display with visual preview
- [ ] "Follow system" checkbox works
- [ ] Theme applies immediately when selected (preview)
- [ ] Selected theme saved to user preferences

### Dashboard Preferences
- [ ] View mode selection (cards/table) works
- [ ] "All regions" vs "My region" toggle works
- [ ] Region dropdown shows only when "My region" selected
- [ ] Region dropdown populated with active regions

### WS Credentials
- [ ] Can skip without entering credentials
- [ ] Credentials validated against WS API (if entered)
- [ ] Error shown if credentials invalid
- [ ] Success links account and updates user

### Completion
- [ ] All preferences saved to database
- [ ] `onboarded_at` timestamp set
- [ ] User redirected to dashboard
- [ ] Dashboard respects saved preferences

---

## Decisions Made

| Decision | Choice |
|----------|--------|
| Number of steps | 5 (Welcome, Theme, Preferences, WS Creds, Complete) |
| WS credentials | Optional, can skip |
| Theme preview | Visual thumbnails showing color scheme |
| Region selection | Only shown when "My region" selected |
| After completion | Redirect to Overview dashboard |

---

## Approval Status

**Status:** Draft - Awaiting Review

**To approve:** Reply "Approved" after reviewing.
